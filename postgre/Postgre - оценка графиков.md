## 1

### Причины

- **Медленные диски** (например, HDD вместо SSD или перегруженные SSD).
- **Плохая настройка запросов или высокая конкуренция за диск**.
- **Виртуализация**: недостаток ресурсов CPU из-за "steal time".
- **Проблемы с автоподдержкой БД** (например, в это время может идти autovacuum, бэкапы, репликация, тяжелые запросы).

### Что можно сделать:

1. **Проверить активность на дисках**:
    - Посмотреть IOPS и latencies через `iostat`, `iotop`, или мониторинг в вашей системе.
    - Посмотреть, какие запросы шли в это время (`pg_stat_activity`, slow query log).
        
2. **Оптимизация запросов**:
    - Найти тяжелые запросы (например, использовать `pg_stat_statements`) и оптимизировать их.
    - Индексы, переписывание запросов, изменение архитектуры.
    
3. **Настройка БД**:
    - Увеличить размеры буферов (`shared_buffers`, `work_mem`).
    - Подобрать параметры для autovacuum, если это его работа вызывает нагрузку.
    
4. **Проблема с виртуализацией**:
    - Переместить БД?
    - Или попросить облачного провайдера выделить больше CPU ресурсов 
    
5. **Переезд на более быстрые диски**:
    - SSD
    - Проверить RAID-контроллер, если используется.


## 2

### Проблемы:

1. **Высокая загрузка CPU и дисковая задержка (iowait)**:
	- Серверу не хватает CPU и/или диск перегружен
	- Из-за iowait приложение не может быстро обрабатывать запросы.

2. **Низкий Cache Hit в PostgreSQL**:
	- БД вместо быстрого ответа из памяти ходит за данными на диск.
	- Это многократно увеличивает задержки.

3. **Почти заполненный диск**:
	- При >80% начинается фрагментация и рост времени отклика файловой системы.

4. **Пиковые нагрузки, превышающие возможности сервера**:
	- Load Average выше числа ядер.
	- Нагрузка скачет, сервер не справляется на пиках.

### Что можно сделать:

1. **Увеличить RAM:
    - Больше памяти позволит больше данных держать в кэшах (целиться на Cache Hit Ratio > 95%)
        
2. **Оптимизировать PostgreSQL настройки**:
    - Увеличить `shared_buffers` (до 25–40% от RAM).
    - Настроить `work_mem`, чтобы минимизировать временные файлы.
    - Настроить `effective_cache_size` ближе к объему доступной RAM.
        
3. **Проверить тяжелые запросы**:
    - Использовать `pg_stat_statements`.
    - Индексировать часто используемые запросы.
    - Упрощать и переписывать тяжелые выборки.
        
4. **Работа с дисками**:
    - Убедиться, что используется быстрый диск
    - Перераспределить нагрузку по таблицам (например, вынести архивные данные в отдельную БД).
    - Очистить ненужные данные.
    - Регулярно проводить `VACUUM FULL` и `REINDEX` для освобождения пространства.
        
5. **Рассмотреть горизонтальное масштабирование**:
    - Выделить реплику для чтения.
    - Использовать шардирование по крупным таблицам.
  
6. **Контроль за резервными копиями, автovacuum и batch-процессами**:
    - Переносить тяжелые фоновые задачи на менее загруженные часы.

7. **Проблема почти заполненного диска**:
    - Очистить старые WAL-логи?
    - Провести аудит ненужных таблиц, архивов, логов.

## 3

### Проблемы:

1. **Много висящих транзакций**:
- Клиентские приложения неправильно обрабатывают транзакции

2. **Проблемы с вводом-выводом** (WALSync, DataFileRead):
- Большая нагрузка на WAL и дисковую подсистему из-за множества INSERT-операций.

3. **Пиковая нагрузка в AAS до 43**:
- Сервер не справляется в моменты пиковых вставок и зависших транзакций.


### Что можно сделать:

1. **Оптимизация клиентского кода**:
    - **Всегда быстро закрывать транзакции**
    - Настроить таймауты на стороне БД (`idle_in_transaction_session_timeout`).
        
2. **Улучшение производительности INSERT/COMMIT операций**:
    - Использовать **batch insert** вместо большого количества одиночных вставок.
    - Переносить INSERT-операции в фоновый режим, если возможно.

3. **Оптимизация работы с WAL**:    
    - Проверить настройки `wal_writer_delay`, `commit_delay`.
    - Если возможно, уменьшить частоту fsync/commit операций, либо использовать группировку транзакций.
    
4. **Разгрузка дисков**:
    - Перевести WAL и данные на разные устройства?
    - Использовать более быстрые диски (NVMe).
    